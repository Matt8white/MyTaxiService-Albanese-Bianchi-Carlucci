\pagebreak
\section{Algorithm Design}

\subsection{Taxi Allocation Daemon}
In this chapter there are some of the useful algorithms used in this project.
The first one is the taxi allocation daemon which receives 
new taxi requests and allocates a TaxiHandler for each request.

\lstset{
language=Java,
numbersep=10pt,
numbers=left,
frame=single,
}
\begin{lstlisting}[caption={Taxi allocation daemon}]
class TaxiAllocationDaemon extends Thread {
    /** Available taxis */
    private Map<Zone, LinkedList<Taxi>> taxis;

    /** A blocking queue containing new rides */
    private LinkedBlockingQueue<Ride> rides;

    public TaxiAllocationDaemon (Map<Zone, 
        LinkedList<Taxi>> taxis, 
        LinkedBlockingQueue<Ride> rides) {

        /** Move arguments to class variables */
        this.taxis = taxis;
        this.rides = rides;
    }

    public void run() {
        System system = System.getInstance();

        /** Keep looping while system is running */
        while(system.isRunning()) {
            /** Get the next ride.(Blocking call) */
            Ride ride = rides.take();

            /** Get the associated zone */
            Zone zone = ride.getZone();

            /** Create and launch a TaxiHandler */
            new TaxiHandler(taxis.get(zone), ride)
                .start(); 
        }
    }
}
\end{lstlisting}
\pagebreak

\subsection{TaxiHandler}
This code is needed to find a suitable taxi for the designated ride.

\begin{lstlisting}[caption={TaxiHandler}]
class TaxiHandler extends Thread {
    private LinkedList<Taxi> taxis;
    private Ride ride;

    public TaxiHandler(LinkedList<Taxi> taxis, 
        Ride ride) {
        this.ride = ride;
        this.taxis = taxis;
    }

    @Override
    public void run() {
        /** Get the number of passengers */
        int nrPeople = ride.getNumberOfPassengers();
        Taxi designatedTaxi = null;

        /** Find a valid taxi */
        for(Taxi taxi : taxis) {
            if(taxi.availableSeats() >= nrPeople) {
                designatedTaxi = taxi;
                break;
            }
        }

        /** No taxi available */
        if(designatedTaxi == null) {
            throw new AgainstAssumptionsException();
        }

        /** Bind the taxi with the ride */
        bindTaxi(taxi, ride);
        
        /** This taxi is now busy. */
        taxis.remove(taxi);
    }
}
\end{lstlisting}
\pagebreak


\subsection{Process call algorithm}
This algorithm is needed to process a call and add that in a suitable ride.
It takes as input parameter the call and returns the associated ride.

\begin{lstlisting}[caption={processCall()}]
public Ride processCall(Call call) {
    /** Is this call is a shareable reservation? */
    if(call instanceof Reservation && 
        ((Reservation)call).isShareable() {

        System system = System.getInstance();

        /** Get call parameters, 
         *  used to lookup active rides */
        Address startPoint = call.getStartPoint();
        Address endPoint = call.getEndPoint();
        int nrPeople = call.getNrPeople();

        /** Find a suitable ride */
        Ride ride = system.lookupSharedRide(
            startPoint, 
            endPoint, 
            nrPeople
        );

        /** There is a suitable shared ride. */
        if(ride != null) {
            ride.addCall(call);
            return ride;
        }
        
        /** Otherwise, create a new shared ride */
        return system.createSharedRide(call);
    } else {
        /** This call is not shareable. 
         *  Let's create a new normal ride
         */
        return system.createNormalRide(call); 
    }
}
\end{lstlisting}
\pagebreak
\subsection{Divide fees}
This is a quite simple algorithm used to divide the fee between 
people who are joining the ride.

Be careful, a check about $ nrPeople > 0 $ is needed in order to prevent
a division by zero.

\begin{lstlisting}[caption={Divide fees between partecipants}]
public void divideFees(double totalFee, int nrPeople) {
    if(nrPeople < 1)
        throw new InvalidNumberOfPeopleException();

    return totalFee / nrPeople;
}
\end{lstlisting}
